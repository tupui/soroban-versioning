---
import Topic from "./utils/Topic.astro";
import Modal from "./utils/Modal.astro";
import Loading from "./utils/Loading.astro";
import CommitHistory from "./CommitHistory.jsx";
---

<div class="relative flex flex-col items-center md:flex-row justify-between">
  <Topic title="Project" description="Details about the project" id="project-name-topic"/>
  <div id="open-update-config-modal-button" class="mb-1.5 mt-12 pr-3 hidden">
    <button
      update-config
      aria-controls="update-config-modal"
      class="w-full p-3 bg-zinc-900 rounded-[14px] justify-center gap-2.5 inline-flex"
    >
      <span class="text-center text-white text-xl font-normal leading-7">
        Update Config
      </span>
    </button>
  </div>
</div>

<div
  class="relative flex flex-col items-center md:flex-row my-6 bg-zinc-100 rounded-[45px]"
>
  <div class="row items-center py-12 px-4 md:px-20 w-full md:py-10">
    <div class="space-y-6 md:w-full">
      <div id="project-name" class="flex items-center space-x-2">
        <h3 class="text-lg font-semibold">Project Name:</h3>
        <p id="project-name-value" class="text-3xl font-bold"></p>
      </div>
      <div id="project-maintainers" class="space-y-2">
        <h3 class="text-lg font-semibold">Maintainers:</h3>
        <ul class="list-disc list-outside pl-4"></ul>
      </div>
      <div class="flex items-center space-x-4">
        <div id="project-link" class="flex items-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
          </svg>
          <a href="#" id="github-link" class="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">Link to GitHub</a>
        </div>
        <div id="view-commit-history" class="flex items-center space-x-2 cursor-pointer hover:bg-zinc-300 transition-colors duration-300 rounded-lg px-2 py-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path id="commit-icon-up" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
            <path id="commit-icon-down" class="hidden" fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
          </svg>
          <span id="view-commit-text">View Commit History</span>
        </div>
      </div>
    </div>
    <div id="commit-history-container" class="mt-4 overflow-hidden transition-all duration-300 max-h-0">
      <CommitHistory client:load/>
    </div>
  </div>
</div>

<Modal id="update-config-modal" title="Update Config">
  <div id="modal-content" class="space-y-4 w-[600px]">
    <h2 id="modal-project-name" class="text-3xl font-bold mb-4">Project Name</h2>

    <label class="block mb-2 text-base font-medium text-black">
      Maintainers
      <input
        type="text"
        id="modal-maintainers"
        class="block p-3 w-full text-base text-black bg-white rounded-lg border shadow-sm focus:ring-black focus:border-black"
        placeholder="List of maintainers' addresses as G...,G..."
        required
      />
    </label>

    <label class="block mb-2 text-base font-medium text-black">
      GitHub repository URL
      <input
        type="text"
        id="modal-config-url"
        class="block p-3 w-full text-base text-black bg-white rounded-lg border shadow-sm focus:ring-black focus:border-black"
        placeholder="GitHub repository URL"
        required
      />
    </label>

    <label class="block mb-2 text-base font-medium text-black">
      Information file hash
      <input
        type="text"
        id="modal-config-hash"
        class="block p-3 w-full text-base text-black bg-white rounded-lg border shadow-sm focus:ring-black focus:border-black"
        placeholder="Information file hash"
        required
        minlength="40"
        maxlength="40"
      />
    </label>

    <div id="wrap-update-button" class="relative">
      <button
        id="update-config-button"
        class="w-full py-5 bg-zinc-900 rounded-[14px] justify-center gap-2.5"
      >
        <span class="text-center text-white text-xl font-normal leading-7">
          Update Config
        </span>
      </button>
      <div id="update-config-loader" class="absolute top-0 left-0 w-full h-full bg-zinc-900 rounded-[14px] justify-center items-center hidden">
        <Loading theme="dark" />
      </div>
    </div>
  </div>
</Modal>

<script>
  import { getProject, getProjectHash, updateConfig } from "../service/ProjectService";
  import { initializeProjectState, loadedProjectInfo, setProject, setProjectLatestSha } from "../service/StateService";
  import { loadedPublicKey } from "./stellar-wallets-kit";

  document.addEventListener("astro:page-load", () => {
    initializeProjectState();
    const modal = document.getElementById("update-config-modal") as HTMLDialogElement;

    function updateProjectInfo() {
      const projectInfo = loadedProjectInfo();
      if (projectInfo) {
        const projectNameElement = document.getElementById("project-name-value");
        if (projectNameElement) {
          projectNameElement.textContent = projectInfo.name;
        }
        const maintainersList = document.getElementById("project-maintainers");
        if (maintainersList) {
          const ul = maintainersList.querySelector("ul");
          if (ul) {
            ul.innerHTML = '';
            projectInfo.maintainers.forEach((maintainer: string) => {
              const li = document.createElement("li");
              li.className = "relative";

              const content = document.createElement("p");
              content.className = "truncate";
              content.textContent = maintainer;

              li.appendChild(content);

              const popup = document.createElement("p");
              popup.className = "absolute left-0 bottom-full mb-1 bg-black text-white text-xs p-1 rounded hidden before:content-[''] before:absolute before:left-1/2 before:top-full before:-translate-x-1/2 before:border-4 before:border-transparent before:border-t-black";
              popup.textContent = maintainer;
              li.appendChild(popup);
              
              li.addEventListener("mouseenter", () => {
                popup.classList.remove("hidden");
              });
              
              li.addEventListener("mouseleave", () => {
                popup.classList.add("hidden");
              });
              
              ul.appendChild(li);
            });
          }
        }
        const githubLink = document.getElementById("github-link") as HTMLAnchorElement;
        if (githubLink) {
          githubLink.href = `${projectInfo.config.url}`;
        }

        // Update modal content
        const modalProjectName = document.getElementById("modal-project-name");
        if (modalProjectName) {
          modalProjectName.textContent = projectInfo.name;
        }
        
        const modalMaintainers = document.getElementById("modal-maintainers") as HTMLInputElement;
        if (modalMaintainers) {
          modalMaintainers.value = projectInfo.maintainers.join(',');
        }
        const modalConfigUrl = document.getElementById("modal-config-url") as HTMLInputElement;
        if (modalConfigUrl) {
          modalConfigUrl.value = projectInfo.config.url;
        }
        const modalConfigHash = document.getElementById("modal-config-hash") as HTMLInputElement;
        if (modalConfigHash) {
          modalConfigHash.value = projectInfo.config.hash;
        }

        // Check if the connected wallet is a maintainer
        const connectedPublicKey = loadedPublicKey();
        const isMaintainer = connectedPublicKey ? projectInfo.maintainers.includes(connectedPublicKey) : false;
        const updateConfigButton = document.getElementById("open-update-config-modal-button");
        if (updateConfigButton) {
          updateConfigButton.classList.toggle("hidden", !isMaintainer);
        }
      }
    }

    
  async function updateProjectLatestSha() {
    try {
      const latestSha = await getProjectHash();
      if (latestSha) {
        setProjectLatestSha(latestSha);
      }
    } catch (error) {
      console.error("Error updating project latest SHA:", error);
    }
  }

    updateProjectInfo();
    updateProjectLatestSha();  // Call this function to update the latest SHA

    const button = document.querySelector(
      "[update-config]",
    ) as HTMLButtonElement; 
    if (button) {
      button.addEventListener("click", async () => {
          console.log("Update config button clicked");
          modal.showModal();
      });
    }

    const updateConfigButton = document.getElementById("update-config-button");
    const updateConfigLoader = document.getElementById("update-config-loader");
    if (updateConfigButton && updateConfigLoader) {
      updateConfigButton.addEventListener("click", async () => {
        const modalMaintainers = (document.getElementById("modal-maintainers") as HTMLInputElement).value;
        const modalConfigUrl = (document.getElementById("modal-config-url") as HTMLInputElement).value;
        const modalConfigHash = (document.getElementById("modal-config-hash") as HTMLInputElement).value;

        updateConfigLoader.style.display = "inline-flex";

        try {
          const updateStatus = await updateConfig(
            modalMaintainers,
            modalConfigUrl,
            modalConfigHash
          );

          if (updateStatus) {
            const project = await getProject();
            if (project && project.name && project.config && project.maintainers) {
              setProject(project);
            }
            updateProjectInfo();
            (document.getElementById("update-config-modal") as HTMLDialogElement).close();
          } else {
            alert("Failed to update project config. Please try again.");
          }
        } catch (error) {
          console.error("Error updating config:", error);
          alert("An error occurred while updating the project config. Please try again.");
        } finally {
          updateConfigLoader.style.display = "none";
        }
      });
    }

    const viewCommitHistory = document.getElementById("view-commit-history");
    const viewCommitText = document.getElementById("view-commit-text");
    const commitHistoryContainer = document.getElementById("commit-history-container");
    const commitIconUp = document.getElementById("commit-icon-up");
    const commitIconDown = document.getElementById("commit-icon-down");

    if (viewCommitHistory && viewCommitText && commitHistoryContainer && commitIconUp && commitIconDown) {
      viewCommitHistory.addEventListener("click", () => {
        if (commitHistoryContainer.style.maxHeight === "0px" || !commitHistoryContainer.style.maxHeight) {
          commitHistoryContainer.style.maxHeight = `${commitHistoryContainer.scrollHeight}px`;
        } else {
          commitHistoryContainer.style.maxHeight = "0px";
        }
      });

      commitHistoryContainer.addEventListener("transitionend", () => {
        if (commitHistoryContainer.style.maxHeight === "0px") {
          viewCommitText.textContent = "View Commit History";
          commitIconUp.classList.remove("hidden");
          commitIconDown.classList.add("hidden");
        } else {
          viewCommitText.textContent = "Hide Commit History";
          commitIconUp.classList.add("hidden");
          commitIconDown.classList.remove("hidden");
          setTimeout(() => {
            const latestCommit = document.getElementById('latest-commit-record');
            if (latestCommit) {
              latestCommit.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 1000);
        }
      });
    }

    window.addEventListener('walletConnected', (_event: Event) => {
      const projectInfo = loadedProjectInfo();
      
      if (projectInfo) {
        const connectedPublicKey = loadedPublicKey();
        const isMaintainer = connectedPublicKey ? projectInfo.maintainers.includes(connectedPublicKey) : false;
        const updateConfigButton = document.getElementById("open-update-config-modal-button");
        if (updateConfigButton) {
          updateConfigButton.classList.toggle("hidden", !isMaintainer);
        }
      }
    });
  });
</script>
