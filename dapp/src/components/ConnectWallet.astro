---
// ConnectWallet.astro (JSR-only)
// All wallet logic now dynamically imports getKit to avoid TS warnings
---
<div id="connect-wrap" class="relative">
  <button
    id="connect-button"
    class="h-10 px-4 flex items-center gap-2 bg-white shadow-button text-pink font-medium rounded"
    aria-label="Connect wallet"
    title="Connect your wallet"
  >
    <span id="connect-text">Connect</span>
    <img src="/icons/connect.png" alt="Connect wallet icon" class="w-5 h-5"/>
  </button>
</div>

<script type="module">
  let publicKey = null;

  const button = document.getElementById("connect-button");
  const textEl = document.getElementById("connect-text");

  async function setLoggedIn(address) {
    textEl.textContent = "Profile";
    button.classList.remove("bg-white", "text-pink");
    button.classList.add("bg-primary", "text-white");
    button.title = address;
    publicKey = address;

    // Notify global or store if needed
    window.dispatchEvent(
      new CustomEvent("walletConnected", { detail: { address } })
    );

    localStorage.setItem("publicKey", address);
  }

  async function connectWallet() {
    try {
      // Dynamically import getKit to avoid TS warnings
      const { getKit } = await import("./stellar-wallets-kit-wrapper");

      const walletKit = await getKit();

      console.log("Opening wallet modal...");
      await walletKit.openModal();

      // After wallet selected, read address
      const { address } = (await walletKit.getSelectedWallet?.()) || {};

      if (!address) return;

      await setLoggedIn(address);
    } catch (err) {
      console.error("Wallet connection failed:", err);
    }
  }

  button.addEventListener("click", connectWallet);

  // Auto-update if already connected
  const stored = localStorage.getItem("publicKey");
  if (stored) setLoggedIn(stored);
</script>