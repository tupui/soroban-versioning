<div id="connect-wrap" class="wrap" aria-live="polite">
  <button data-connect aria-controls="connect-wrap">Connect</button>
</div>

<style>
  .wrap {
    text-align: center;
    max-width: 12rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>

<script>
  import { kit, loadedPublicKey, setPublicKey } from "./stellar-wallets-kit";

  document.addEventListener("astro:page-load", () => {
    const button = document.querySelector(
      "[data-connect]",
    ) as HTMLButtonElement;

    async function setLoggedIn(publicKey: string) {
      button.textContent = `Signed in as ${publicKey}`;
    }

    const connectedPublicKey = loadedPublicKey();
    if (connectedPublicKey) {
      setLoggedIn(connectedPublicKey);
    }

    if (button) {
      button.addEventListener("click", async () => {
        try {
          await kit.openModal({
            onWalletSelected: async (option: { id: string }) => {
              try {
                kit.setWallet(option.id);
                const { address } = await kit.getAddress();
                setPublicKey(address);
                await setLoggedIn(address);
                window.dispatchEvent(new CustomEvent('walletConnected', { detail: address }));
              } catch (e) {
                console.error(e);
              }
            },
          });
        } catch (e) {
          console.error(e);
        }
      });
    }
  });
</script>
