---
import ConnectWallet from "../ConnectWallet.astro";
import JoinCommunityButton from "../JoinCommunityButton.tsx";
import NavbarSearch from "../NavbarSearch.tsx";

const { page } = Astro.props;
---

<header role="banner">
  <nav
    class="w-full px-[24px] md:px-[60px] lg:px-[120px]"
    role="navigation"
    aria-label="Main navigation"
  >
    <div class="max-w-[1920px] mx-auto">
      <div class="pt-[40px] md:pt-[60px] flex items-center h-16">
        <!-- Logo and text on left -->
        <div class="flex items-center gap-2 md:gap-3 flex-shrink-0">
          <a href="/" class="flex-shrink-0" aria-label="Tansu homepage">
            <img
              alt="Tansu logo"
              src="/logo.svg"
              class="h-8 md:h-10 lg:h-12"
              width="48"
              height="48"
            />
          </a>
          <div class="hidden lg:flex items-center gap-2 whitespace-nowrap">
            <p class="text-base md:text-lg font-bold text-primary leading-none">
              Tansu
            </p>
            <p class="text-sm font-bold text-secondary leading-none">- alpha</p>
          </div>
        </div>

        <!-- Search bar - takes remaining space -->
        <div class="flex-1 flex justify-start ml-3 md:ml-4">
          <NavbarSearch client:load onAddProject={() => {}} />
        </div>

        <!-- Wallet connect and community button on right -->
        <div class="flex items-center gap-4 md:gap-6 flex-shrink-0">
          <div class="ml-6">
            <ConnectWallet />
          </div>
          <div id="join-community-wrapper" class="hidden sm:block">
            <JoinCommunityButton client:load />
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  // Toggle Join Community button visibility
  const updateJoinButtonVisibility = () => {
    const publicKey = localStorage.getItem("publicKey");
    const wrapper = document.getElementById("join-community-wrapper");
    if (wrapper) {
      wrapper.style.display = publicKey ? "none" : "block";
    }
  };

  // Initialize global event listeners once
  const initGlobalListeners = () => {
    if (window.globalListenersInited) return;
    window.globalListenersInited = true;

    const createProjectEvent = new CustomEvent("create-project-global");

    // Handle create project modal trigger
    document.addEventListener("show-create-project-modal", () => {
      if (window.location.pathname !== "/") {
        sessionStorage.setItem("openCreateProjectModal", "true");
        window.location.href = "/";
      } else {
        document.dispatchEvent(createProjectEvent);
      }
    });

    // Wallet connection events
    window.addEventListener("walletConnected", updateJoinButtonVisibility);
    window.addEventListener("walletDisconnected", updateJoinButtonVisibility);
  };

  // Run visibility & listeners setup on page load
  document.addEventListener("astro:page-load", () => {
    updateJoinButtonVisibility();
    initGlobalListeners();
  });

  // Run immediately for initial load
  updateJoinButtonVisibility();
  initGlobalListeners();
</script>
